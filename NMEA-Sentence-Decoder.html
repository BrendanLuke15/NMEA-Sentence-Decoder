<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMEA Sentence Decoder</title>
    <meta name="description" content="Turn a .txt file of NMEA Sentences or a text input to a CSV file of GNSS/positional data">
    <meta name="author" content="Brendan Luke">
    <!--
        Date: August 6, 2021
    -->
</head>
<style>
button {
    font-size: 5vh;
    color: white;
    border-radius: 1vh;
    padding: 1.2vh 2vw;
    background-color: #45900f;
    border: 0.4vh solid #444;
    transition-duration: 0.25s;
}
button:hover {
    color: #0d5198;
    border-color: #0d5198;
}
</style>
<body style="background-color: #666;">
    <div id="inputHouse" style="display: flex;">
        <div id="border1" style="display:flex; justify-content:center; align-items:center; width: 45vw; height: 35vh; background-color: #45900f; margin-top: 31vh; margin-left: 3vw; border-radius: 3vw;">
            <div id="uploadButtonHouse" style="width: 42vw; height: 32vh; background-color: #eee; margin: none; border-radius: 3vw;">
                <button onclick="fileUpload()" style="width: 35vw; height: 25vh; margin-top: 3.5vh; margin-left: 3.5vw;">Upload NMEA Sentences .txt File</button>
                <input type="file" id="fileInput" accept=".txt" style="display: none;"/> <!--  this element is hidden and activated by button click^ because it has limited styling -->
            </div>
        </div>
        <div id="border2" style="display:flex; justify-content:center; align-items:center; width: 45vw; height: 35vh; background-color: #45900f; margin-top: 31vh; margin-left: 3vw; border-radius: 3vw;">
            <div id="uploadButtonHouse" style="width: 42vw; height: 32vh; background-color: #eee; margin: none; border-radius: 3vw;">
                <label for="input" style="font-family: Arial, Helvetica, sans-serif; position: relative; left: 5vw; top: 1vh; font-size: 2vh; line-height: normal; color: #45900f;">Paste NMEA Sentences here</label>
                <textarea id="textInput" name="input" style="width: 35vw; height: 25vh; margin-top: 1.5vh; margin-left: 3.5vw;"></textarea>
            </div>
        </div>
    </div>
    <div id="submitHouse">
        <button id="submitText" onclick="textSubmit()" style="position: relative; left: 30vw; width: 40vw; top: 5vh;">Submit Text Input</button>
    </div>
</body>
<script>
    // Read uploaded .txt file case:
    inputButton = document.getElementById('fileInput');
    inputButton.addEventListener('change',fileUpload); // add event listener for change in fileInput
    function fileUpload() {
        document.getElementById('fileInput').click();
        var file = this.files[0]; // get the first file
        var fileName = file.name; // filename of uploaded file
        var reader = new FileReader(); // create new file reader
        reader.readAsBinaryString(file); // required
        reader.onload = function(e) { // when file upload is completed do the following:
            let data = e.target.result; // data string 
            output(data,fileName);
        }
    }

    // Read submitted text case:
    function textSubmit() {
        var data = document.getElementById('textInput').value; // get contents of textInput element
        if (data === "") { // check if input is empty
            alert('Please submit data to the text input area.'); // alert user to input data
        } else {
            output(data,"Output NMEA Sentences.txt");
        }
    }

    // Output function
    function output(data,fileName) {
        data = data.split('\n'); // split data into array by new line
        var csvString = 'NMEA Sentence:,Time & Date:,Validity:,Latitude (deg):,Longitude (deg):,Altitude ASL (m):,True Track (deg):,'
            + 'Magnetic Track (deg):,Ground Speed (kts):,Height Above Geoid (m):,PDOP:,HDOP:,VDOP:,X (m):,Y (m):,Z (m):,Satellites in View (#):,'
            + 'Space Vehicle ID:,Elevation (deg):,Azimuth (deg):,SNR (dB):,Active Satellites:,Magnetic Variation (deg):,Mode:,Fix Type:,Fix Quality:\n'; // initialize final data holder with column headers
        setComplete = false; // initialize logic bit to FALSE
        for (let i = 0; i < data.length; i++) { // start from first line
            var sentenceType = (data[i].substring(0,6)).substring(3,6); // type of NMEA sentence
            //console.log(sentenceType);

            // Parse sentences & return data (only GGA, RMC, VTG for now, GSA for DOP's)
            if (sentenceType === "GGA") {
                outGGA = GGA(data[i]); // call GGA parsing function
                setComplete = true; // set logic bit to TRUE
            } else if (sentenceType === "GSV") {
                outGSV = GSV(data[i]); // call GSV parsing function
            } else if (sentenceType === "GSA") {
                outGSA = GSA(data[i]); // call GSA parsing function
            } else if (sentenceType === "VTG") {
                outVTG = VTG(data[i]); // call VTG parsing function
            } else if (sentenceType === "RMC") {
                outRMC = RMC(data[i]); // call RMC parsing function
            } else { // invalid sentence type
                // alert?
            }

            // When next sentence is GGA, combine data into one CSV row
            /*
                consider GGA to be the last sentence returned in a set
            */
            if (setComplete) { // write data to CSV row if set complete is TRUE (sentence is GGA; indicating end of set)
                timeDateString = 'future work'; // formatted time & date string

                // Below is all for getting cartesian corrdinates in ECEF coordinate system
                heightAboveEllipsoid = parseFloat(outGGA.GeoidHeight) + parseFloat(outGGA.ASL); // height above WGS-84 ellipsoid
                geocentricLatitude = Math.atan(Math.pow(1-1/298.257223563,2)*Math.tan(parseFloat(outGGA.Latitude)/180*Math.PI)); // convert geodetic latitude to geocentric latitude (radians)
                R = Math.pow(6378137,3)*(1-1/298.257223563)/Math.sqrt(Math.pow(6378137,4)*Math.pow(Math.sin(geocentricLatitude),2) + Math.pow(1-1/298.257223563,2)*Math.pow(6378137,4)*Math.pow(Math.cos(geocentricLatitude),2)*(Math.pow(Math.cos(parseFloat(outGGA.Longitude)/180*Math.PI),2)+Math.pow(Math.sin(parseFloat(outGGA.Longitude)/180*Math.PI),2))) + heightAboveEllipsoid; // distance to center of Earth
                X = R*Math.cos(geocentricLatitude)*Math.cos(parseFloat(outGGA.Longitude)/180*Math.PI);
                Y = R*Math.cos(geocentricLatitude)*Math.sin(parseFloat(outGGA.Longitude)/180*Math.PI);
                Z = R*Math.sin(geocentricLatitude);

                

                // write to output CSV string
                csvString = csvString + "future work," + timeDateString + ',"FQ: ' + outGGA.FixQual + ', RxWarn: ' + outRMC.RxWarn + '",' + outGGA.Latitude
                    + "," + outGGA.Longitude + "," + outGGA.ASL + "," + outVTG.GroundTrackTrue + "," + outVTG.MagneticGroundTrack + "," + outVTG.GroundSpeedKts
                    + "," + outGGA.GeoidHeight + "," + outGSA.PDOP + "," + outGSA.HDOP + "," + outGSA.VDOP + "," + X + "," + Y + "," + Z + "\n"; // CSV formatted output string
            }            
        }

        let blobFile = new Blob([csvString], {type: 'text/plain'}); // creates new blob data type from 'csvString' string variable
        // below creates file and downloads it to user's computer
        var a = document.createElement("a"),
        url = URL.createObjectURL(blobFile);
        a.href = url;
        a.download = fileName.substring(0,fileName.length-4) + ".csv";
        document.body.appendChild(a);
        a.click(); 
    }

    // NMEA Sentences to parse:
    // - GGA: Fix data (lat, lon, alt, time, HDOP)
    // - GSV: Sats in view
    // - GSA: Dillution of precision + active Sats
    // - VTG: track, ground speed
    // - RMC: Recommended minimum specific GPS/Transit data (date)

    // GGA Parsing Function
    function GGA(sentence) {
        var temp = sentence.split(","); // split sentence by commas
        const outObject = {UTC:"", Latitude:"", Longitude:"", FixQual:"", NumSatsUse:"", HDOP:"", ASL:"", GeoidHeight:""}; // declare empty object

        // Write data from sentence to object
        outObject.UTC = temp[1].substring(0,2).concat(":",temp[1].substring(2,4),":",temp[1].substring(4,100)); // write time in 'hh:mm:ss.ss' format
        // Lat & Lon Logic:
        if (temp[3] == "N") { // North latitude
            outObject.Latitude = parseFloat(temp[2].substring(0,2)) + parseFloat(temp[2].substring(2,100))/60; // write Latitude (fixed to actual #)
        } else { // South latitude
            outObject.Latitude = -1*parseFloat(temp[2].substring(0,2)) + parseFloat(temp[2].substring(2,100))/60; // write Latitude (fixed to actual #)
        }
        if (temp[5] == "E") { // East longtitude
            outObject.Longitude = parseFloat(temp[4].substring(0,3)) + parseFloat(temp[4].substring(3,100))/60; // write Longitude (fixed to actual #)
        } else { // West longitude
            outObject.Longitude = -1*(parseFloat(temp[4].substring(0,3)) + parseFloat(temp[4].substring(3,100))/60); // write Longitude (fixed to actual #)
        }
        outObject.FixQual = temp[6]; // write fix quality
        outObject.NumSatsUse = temp[7]; // write # of Sats used
        outObject.HDOP = temp[8]; // write HDOP
        outObject.ASL = temp[9]; // write height ASL
        outObject.GeoidHeight = temp[11]; // write height above geoid

        return outObject; // return output
    }

    // GSV Parsing Function
    function GSV(sentence) {
        var temp = sentence.split(","); // split by commas

    }

    // GSA Parsing Function
    function GSA(sentence) {
        var temp = sentence.split(","); // split by commas
        const outObject = {PDOP:"", HDOP:"", VDOP:""}; // declare empty outObject

        // Write data from sentence to object
        outObject.PDOP = temp[15]; // write PDOP
        outObject.HDOP = temp[16]; // write HDOP
        outObject.VDOP = temp[17]; // write VDOP

        return outObject; //return output
    }

    // VTG Parsing Function
    function VTG(sentence) {
        var temp = sentence.split(","); // split by commas
        const outObject = {GroundTrackTrue:"", MagneticGroundTrack:"", GroundSpeedKts:"", GroundSpeedKM:""}; // declare empty outObject

        // Write data from sentence to object
        outObject.GroundTrackTrue = temp[1]; // write ground track (true)
        outObject.MagneticGroundTrack = temp[3]; // write ground track (magnetic)
        outObject.GroundSpeedKts = temp[5]; // write ground speed in knots
        outObject.GroundSpeedKM = temp[7]; // write ground speed in km/h

        return outObject; // return output
    }

    // RMC Parsing Function
    function RMC(sentence) {
        var temp = sentence.split(","); // split by commas
        const outObject = {UTC:"", RxWarn:"", Latitude:"", Longitude:"", GroundSpeedKts:"", GroundTrackTrue:"", Day:"", Month:"", Year:"", MagneticVariation:"", GeoidHeight:""}; // declare empty object

        // Write data from sentence to object
        outObject.UTC = temp[1].substring(0,2).concat(":",temp[1].substring(2,4),":",temp[1].substring(4,100)); // write time in 'hh:mm:ss.ss' format
        outObject.RxWarn = temp[2]; // write receiver warning
        // Lat & Lon Logic:
        if (temp[3] == "N") { // North latitude
            outObject.Latitude = parseFloat(temp[2].substring(0,2)) + parseFloat(temp[2].substring(2,100))/60; // write Latitude (fixed to actual #)
        } else { // South latitude
            outObject.Latitude = -1*parseFloat(temp[2].substring(0,2)) + parseFloat(temp[2].substring(2,100))/60; // write Latitude (fixed to actual #)
        }
        if (temp[5] == "E") { // East longtitude
            outObject.Longitude = parseFloat(temp[4].substring(0,3)) + parseFloat(temp[4].substring(3,100))/60; // write Longitude (fixed to actual #)
        } else { // West longitude
            outObject.Longitude = -1*(parseFloat(temp[4].substring(0,3)) + parseFloat(temp[4].substring(3,100))/60); // write Longitude (fixed to actual #)
        }
        outObject.GroundSpeedKts = temp[7]; // write ground speed in knots
        outObject.GroundTrackTrue = temp[8]; // write ground track (true)
        outObject.Day = temp[9].substring(0,2); // write day of month (#)
        outObject.Month = temp[9].substring(2,4); // write month of year (#)
        outObject.Year = temp[9].substring(4,6); // write year (last 2 digits)
        if (temp[11] == "E") { // East variation
            outObject.MagneticVariation = temp[10]; // write magnetic variation
        } else { // West variation
            outObject.MagneticVariation = -1*parseFloat(temp[10]); // write magnetic variation
        }

        return outObject; // return output
    }
</script>
</html>